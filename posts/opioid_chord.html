<!doctype html>
<html lang="en">

<head>
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The Art of Machine Learning</title>
  <meta name="description" content="Machine Learning, Deep Learning, Jenny Yu ">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Regression for taxi data">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://yinniyu.github.io/posts/taxi">
  <meta property="og:site_name" content="The Art of Machine Learning">
  <meta property="og:image" content="">

 
  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
  <link href="http://chalk.nielsenramon.com/feed.xml" type="application/rss+xml" rel="alternate" title="Chalk Last 10 blog posts" />

    <link rel="stylesheet" href="/assets/light.css">
<!-- D3.js -->
     <script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
    <link type="text/css" rel="stylesheet" href="style.css">

     <script type="text/javascript" src="scripts/d3/math/trigonometry.js"></script>

     <script type="text/javascript" src="scripts/d3/svg/arc.js"></script>

     <script type="text/javascript" src="scripts/d3/core/functor.js"></script>
     <script type="text/javascript" src="scripts/d3/core/source.js"></script>
     <script type="text/javascript" src="scripts/d3/core/target.js"></script>

     <script type="text/javascript" src="scripts/d3/layout/arc-chord.js"></script>
     <script type="text/javascript" src="scripts/d3/svg/arc-chord.js"></script>

     <script type="text/javascript" src="scripts/graphic/gradients.js"></script>


 </head>

<body>
  <main>
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav appear">
  <a href="/" class="header-logo" title="The Art of Machine Learning">The Art of Machine Learning</a>
  <ul class="header-links">
       <li>
        <a href="https://yinniyu.github.io/about">About Me
        </a>
      </li>
    
     <li>
        <a href="https://yinniyu.github.io/toolbox">My Toolbox</a>
      </li>
    
     <li>
        <a href="https://github.com/yinniyu" rel="noreferrer noopener" target="_blank" title="GitHub">
          <span class="icon icon-github"></span>
        </a>
      </li>
    
    
      <li>
        <a href="https://linkedin.com/in/jenny-yu-b495243" rel="noreferrer noopener" target="_blank" title="LinkedIn">
          <span class="icon icon-linkedin"></span>
        </a>
      </li>   
  </ul>
</nav>

        
        <article class="article appear">
          <header class="article-header">
            <h1 id="circos plot">Interactive chord diagram in D3 </h1>
            <p>This post revisits the taxi ride data to make an interactive circos diagram in D3. Originally presented in 2009 by Martin Krzywinsk in his 
		    paper "Circos: an Information Aesthetic for Comparative Genomics.", it has become widely used and appreciated outside of the genomic/bioinformatic
		    community. Its aesthetics and features effectively display relationships between different entities or patterns in periodic data.
		  For the taxi data, it's actually quite simple to create a circos Chord diagram by tweaking existing codes 
		    shared by users (i.e, AndrewRP, nbremer) on https://bl.ocks.org/ , plus I will break down the essential elements of the chord diagram.</p>
		  <p><b>Note:If you cannot see the interactive chart after this paragraph, it means the browser is blocking the javascript from being loaded.
			  You can remove the block temporarily by adjusting the security setting on the browser tool bar or location/title bar.
			  If you need help, refer to <a href="http://kb.mcgill.ca/?portalid=2&articleid=5128#tab:homeTab:crumb:8:artId:5128:src:article">
			  this link</a>.</b></p>
            
            <div class="article-list-footer">
              <span class="article-list-date">
                March 26, 2018
              </span>
              <span class="article-list-divider">-</span>
              <span class="article-list-minutes">
              10 minute read
              </span>
              
              <span class="article-list-divider">-</span>
              <div class="article-list-tags">
                
                <span class="article-list-divider">D3, Data visualization, Chord diagram </span>
              </div>
            </div>
          </header>

          <div class="article-content">

		  <div id="chart">
			  
       <div id="mainDiv">
         <div id="imgDiv" style="width:400px; margin:0px auto; margin-top:10px">
             <img id="playPause" src="images/pause_bw.png" width="24" height="24" style="float:left"/>
             <div style="float:left; margin-top:4px; margin-left:4px">click on a bottom timeline year to skip to that point.</div>
         </div>

         <div id="svgDiv" style="font-size:10px; width:650px; height: 800px;"></div>


     </div>
         <div id="toolTip" class="tooltip" style="opacity:0; width:200px; height:90px; position:absolute;">
             <div id="header1" class="header3"></div>
             <div class="header-rule"></div>
             <div id="head" class="header"></div>
             <div class="header-rule"></div>
             <div  id="header2" class="header2"></div>
             <div  class="tooltipTail"></div>
         </div>

     </div>

     <script type="text/javascript" src="scripts/graphic/globals.js"></script>
     <script type="text/javascript" src="scripts/graphic/initialize.js"></script>
     <script type="text/javascript" src="scripts/graphic/events.js"></script>
     <script type="text/javascript" src="scripts/graphic/data.js"></script>
     <script type="text/javascript" src="scripts/graphic/buildChords.js"></script>
     <script type="text/javascript" src="scripts/graphic/update.js"></script>

     <script type="text/javascript">

         initialize();

         fetchData();

         function run() {
             if (year < statesGrouped.length-1) year++; else{
               year=0;
             }
             if (year==maxYear){
               year=0;
             }

             else {
                 update(year);
             }
         }


     </script>

 

		  
		  
		 
<div id='chartdiv'>
	<style> /* set the CSS */

body { font: 12px Arial;}

path {
    stroke: #ccc;
    stroke-width: 2;
    fill: none;
}

.axis path,
.axis line {
    fill: none;
    stroke: grey;
    stroke-width: 1;
    shape-rendering: crispEdges;
}
#legendContainer{
	position:absolute;
	top:60px;
	left:10px;
	overflow: auto;
	height:490px;
	width:110px;
}
#legend{
	width:90px;
	height:200px;
}
.legend {
    font-size: 12px;
    font-weight: normal;
    text-anchor: left;
}
.legendcheckbox{
	cursor: pointer;
}
#showAll{
	position:absolute;
	top:600px;
	left:880px;
}
#clearAll{
	position:absolute;
	top:600px;
	left:950px;
}
input{
	border-radius:5px;
	padding:5px 10px;
	background:#999;
	border:0;
	color:#fff;
}
#inds{
	position:absolute;
	top:10px;
	left:10px;
}
</style>
<body>

<!-- load the d3.js library -->
<script src="http://d3js.org/d3.v3.min.js"></script>
<script> d3version3 = d3 </script>
<script src="//code.jquery.com/jquery-3.2.1.min.js"></script>
<!--<script src="//code.jquery.com/jquery-1.10.2.js"></script> -->
<select id="inds">
		<option value="Arizona" selected="selected">Arizona</option>
		<option value="California">California</option>
		<option value="Colorado">Colorado</option>
    <option value="Connecticut">Connecticut</option>
    <option value="Delaware">Delaware</option>
    <option value="Florida">Florida</option>
    <option value="Georgia">Georgia</option>
    <option value="Illinois">Illinois</option>
    <option value="Indiana">Indiana</option>
    <option value="Kentucky">Kentucky</option>
    <option value="Louisiana">Louisiana</option>
    <option value="Maryland">Maryland</option>
    <option value="Massachusetts">Massachusetts</option>
    <option value="Michigan">Michigan</option>
    <option value="Minnesota">Minnesota/option>
    <option value="Missouri">Missouri</option>
    <option value="Nevada">Nevada</option>
    <option value="New Hampshire">New Hampshire</option>
    <option value="New Jersey">New Jersey</option>
    <option value="New Mexico">New Mexico</option>
    <option value="New York">New York</option>
    <option value="North Carolina">North Carolina</option>
    <option value="Ohio">Ohio</option>
    <option value="Oregon">Oregon</option>
    <option value="Pennsylvania">Pennsylvania</option>
    <option value="Oregon">Oregon</option>
    <option value="South Carolina">South Carolina</option>
    <option value="Tennessee">Tennessee</option>
    <option value="Texas">Texas</option>
    <option value="Utah">Utah</option>
    <option value="Virginia">Virginia</option>
    <option value="Washington">Washington</option>
    <option value="West Virginia">West Virginia</option>
    <option value="Wisconsin">Wisconsin</option>



</select>

<div id="legendContainer" class="legendContainer">
	<svg id="legend"></svg>
</div>
<div id="showAll">
	<input name="showAllButton"
	 type="button"
	 value="Show All"
	 onclick="showAll()" />
</div>
<div id="clearAll">
	<input name="clearAllButton"
	 type="button"
	 value="Clear All"
	 onclick="clearAll()" />
</div>
<script>

function filterJSON(json, key, value) {
  var result = [];
  json.forEach(function(val,idx,arr){
    if(val[key] == value){

      result.push(val)
    }
  })
  return result;
}

// Set the dimensions of the canvas / graph
var margin = {top: 50, right: 20, bottom: 30, left: 160},
    width = 800 - margin.left - margin.right,
    height = 450 - margin.top - margin.bottom,
    padding = 100;

var formatYear = d3version3.format("d");
// Set the ranges
//var x = d3.time.scale().domain([format1("2010"), format1("2017")]).range([0, width]);
var x = d3version3.scale.linear()
    .range([0, width]);
var y = d3version3.scale.linear().range([height, 0]);

// Define the axes
var xAxis = d3version3.svg.axis()
    .scale(x)
    .orient("bottom")
    .tickFormat(formatYear);

var yAxis = d3version3.svg.axis().scale(y)
    .orient("left").ticks(5);

// Define the line
var opioid_typeline = d3version3.svg.line()
		//.interpolate("cardinal")
    .x(function(d) { return x(d.year); })
    .y(function(d) { return y(d.od_counts); });
//DOt


// Adds the svg canvas
var svg = d3version3.select("body")
    .append("svg")
        .attr("width", width+ margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
    .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");
var data=[];
// Get the data
d3version3.json("raw_data/od_types3.json", function(error, json) {
  console.log(json)

  json.forEach(function(d) {
		d.od_counts = +d.od_counts;
  });

	d3version3.select('#inds')
			           .on("change", function () {
				         var sect = document.getElementById("inds");
				         var section = sect.options[sect.selectedIndex].value; //this returns the value of the section, not od_counts

				data = filterJSON(json, 'State', section);
        //console.log(data)

	      //debugger

		    data.forEach(function(d) {
    			d.od_counts = +d.od_counts;
    			d.active = true;
    		});

		    //debugger
				updateGraph(data);

				jQuery('h1.page-header').html(section);
			});

	// generate initial graph
	data = filterJSON(json, 'State', 'Arizona');
	updateGraph(data);

});

var color = d3version3.scale.ordinal().range(["#FF5C55",  "#FFCB57", "#54C6EB",'587291']);

function updateGraph(data) {

    // Scale the range of the data
    x.domain(d3version3.extent(data, function(d) { return d.year; }));
    y.domain([d3version3.min(data, function(d) { return d.od_counts; }), d3version3.max(data, function(d) { return d.od_counts; })]);


    // Nest the entries by opioid_type
    dataNest = d3version3.nest()
        .key(function(d) {return d.opioid_type;})
        .entries(data);


 		var result = dataNest.filter(function(val,idx, arr){
				  return $("." + val.key).attr("fill") != "#ccc"
				  // matching the data with selector status
				})


 		var opioid_type = svg.selectAll(".line")
      .data(result, function(d){return d.key});
     /// add DOt
    var dot = svg.append("g")
         .attr("id", "scatter")
         .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		opioid_type.enter().append("path")
			.attr("class", "line");



		opioid_type.transition()
			.style("stroke", function(d,i) { return d.color = color(d.key); })
			.attr("id", function(d){ return 'tag'+d.key.replace(/\s+/g, '');}) // assign ID
			.attr("d", function(d){
				return opioid_typeline(d.values)
			});

		opioid_type.exit().remove();

		var legend = d3version3.select("#legend")
			.selectAll("text")
			.data(dataNest, function(d){return d.key});

		//checkboxes
		legend.enter().append("rect")
		  .attr("width", 10)
		  .attr("height", 10)
		  .attr("x", 0)
		  .attr("y", function (d, i) { return 0 +i*15; })  // spacing
		  .attr("fill",function(d) {
		    return color(d.key);

		  })
		  .attr("class", function(d,i){return "legendcheckbox " + d.key})
			.on("click", function(d){
			  d.active = !d.active;

			  d3version3.select(this).attr("fill", function(d){
			    if(d3version3.select(this).attr("fill")  == "#ccc"){
			      return color(d.key);
			    }else {
			      return "#ccc";
			    }
			  })


			 var result = dataNest.filter(function(val,idx, arr){
         return $("." + val.key).attr("fill") != "#ccc"
       // matching the data with selector status
      })

       // Hide or show the lines based on the ID
       svg.selectAll(".line").data(result, function(d){return d.key})
         .enter()
         .append("path")
         .attr("class", "line")
         .style("stroke", function(d,i) { return d.color = color(d.key); })
        .attr("d", function(d){
                return opioid_typeline(d.values);
         });

      svg.selectAll(".line").data(result, function(d){return d.key}).exit().remove()

			})

    // Add the Legend text
    legend.enter().append("text")
      .attr("x", 15)
      .attr("y", function(d,i){return 10 +i*15;})
      .attr("class", "legend");

		legend.transition()
      .style("fill", "#777" )
      .text(function(d){return d.key;});

		legend.exit().remove();
		svg.selectAll(".axis").remove();

    // Add the X Axis
    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

    // Add the Y Axis
    svg.append("g")
        .attr("class", "y axis")
        .call(yAxis);
};

function clearAll(){
  d3version3.selectAll(".line")
	.transition().duration(100)
			.attr("d", function(d){
        return null;
      });
  d3version3.select("#legend").selectAll("rect")
  .transition().duration(100)
      .attr("fill", "#ccc");
};

function showAll(){
  d3version3.selectAll(".line")
	.transition().duration(100)
			.attr("d", function(d){
        return opioid_typeline(d.values);
      });
  d3version3.select("#legend").selectAll("rect")
  .attr("fill",function(d) {
    if (d.active == true){
       return color(d.key);
     }
   })
};
// now add titles to the axes
    svg.append("text")
            .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
            .attr("y", 0-margin.left/2)
            .attr("transform", "translate("+ (margin.top/2) +","+(height/2)+")rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate
            .text("Number of overdose deaths");

    svg.append("text")
            .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
            .attr("transform", "translate(" + (width /2) +  " ," + (height + margin.bottom) + ")")
            .text("Year");
</script>
	
	
	
	
	
	
	
	
	
	
	
		  </div>
		  
      
      
      
<p>To embed the D3 javascript into the html, simply call the .js file with the <code class="highlighter-rouge"> script src =""</code> function. In practice, 
	it's common to use <code class="highlighter-rouge"> div </code> to define the area for D3 effects. For example, in this html 
	web page, I inserted the D3 script in between a div element with id called "chart" . The id is called in the chord.js file to 
	select that element by specifying d3.select("div#chart").append("svg"). </p>
		  

<p>I found that the fastest way to hack D3 is by looking at well-annotated codes (I love the ones written by <a href='https://www.visualcinnamon.com/about'>
	Nadieh Bremer </a>) AND using <a href='http://jsfiddle.net/wQXCL/2782/'> JSFiddle interactive tool </a> to test out different javascript and see its effect.
	
<h4 id="reference">REFERENCE</h4>
<p>[1] https://medium.com/@Marianattestad/a-treatise-on-making-circos-plots-from-genomic-data-7ff496849e0</p>
<p>[2] <b>How to create a Flow diagram with a circular Twist</b>, Visual Cinnamon, https://www.visualcinnamon.com/2015/08/stretched-chord.html</p>
		  <p>[3] <i>Andrew's Chord Example </i> http://bl.ocks.org/AndrewRP/7468330 </p>
        

          
            <div id="disqus_thread" class="article-comments"></div>
            <script src="https://chalk-1.disqus.com/embed.js" async defer></script>
            <noscript>Please enable JavaScript to view the comments.</noscript>
          
        </article>
        <footer class="footer appear">
  <p>
    Chalk is a high quality, completely customizable, performant and 100% free
    blog template for Jekyll built by
    <a href="/about" title="About me">Nielsen Ramon</a>. Download it <a href="https://github.com/nielsenramon/chalk" rel="noreferrer noopener" target="_blank" title="Download Chalk">here</a>.
  </p>
</footer>

      </div>
    </div>
  </main>
  
  <script>
    window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
    ga('create','UA-28631876-6','auto');ga('send','pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async></script>


<script src="/assets/vendor.js"></script>



  <script src="/assets/webfonts.js"></script>




  <script src="/assets/scrollappear.js"></script>



<script src="/assets/application.js"></script>

</body>
</html>
