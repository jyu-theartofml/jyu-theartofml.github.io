<!doctype html>
<html lang="en">

<head>
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The Art of Machine Learning</title>
  <meta name="description" content="Machine Learning, Deep Learning, Jenny Yu ">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="How to deploy a Flask app with ease">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://yinniyu.github.io/posts/melanoma.html">
  <meta property="og:site_name" content="The Art of Machine Learning">
  <meta property="og:image" content="images/lesion_app/tech_stack.png">


  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
  <link href="http://chalk.nielsenramon.com/feed.xml" type="application/rss+xml" rel="alternate" title="Chalk Last 10 blog posts" />

    <link rel="stylesheet" href="/assets/light.css">


</head>

<body>
  <main>
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav appear">
  <a href="/" class="header-logo" title="The Art of Machine Learning">The Art of Machine Learning</a>
  <ul class="header-links">

    <li>
        <a href="https://yinniyu.github.io/about">About Me
        </a>
      </li>

    <li>
        <a href="https://yinniyu.github.io/toolbox">My Toolbox</a>
     </li>
     <li>
        <a href="https://yinniyu.github.io/ai_art">AiArt
        </a>
      </li>

    <li>
        <a href="https://github.com/yinniyu" rel="noreferrer noopener" target="_blank" title="GitHub">
          <span class="icon icon-github"></span>
        </a>
      </li>


      <li>
        <a href="https://linkedin.com/in/jenny-yu-b495243" rel="noreferrer noopener" target="_blank" title="LinkedIn">
          <span class="icon icon-linkedin"></span>
        </a>
      </li>
  </ul>
</nav>


        <article class="article appear">
          <header class="article-header">
            <h1>How to deploy a Flask app with ease</h1>
             <figure>
              <img src='images/lesion_app/tech_stack.png' alt="tech_stack" >
               </figure>
            <p>As a Data Scientist, I spend alot of time training, validating, and optimizing models. For a side project,
              I wanted to try deploying a Deep Learning (DL) classifier model to get my hands on the other layers of the
            Machine Learning tech stack. Building a web app is a great way to evaluate the feasibilty of the model
            design and work flow, while showing the value of the machine learning system. For this project, a DenseNet model
          was trained to predict 8 categories of skin lesions using dermascopic images <i>and</i> meta data (e.g., age, gender).
      The web app was build in Flask, wrapped in Docker, and deployed via AWS Elastic Beanstalk(EB). In this blog post, I will
     focus on the deployment process and share the things I learned along the way.</p>

            <div class="article-list-footer">
              <span class="article-list-date">
                November 10th, 2019
              </span>
              <span class="article-list-divider">-</span>
              <span class="article-list-minutes">
              5 minute read
              </span>

              <span class="article-list-divider">-</span>
              <div class="article-list-tags">

                <span class="article-list-divider">PyTorch, Docker, Flask, ElasticBeanstalk </span>
              </div>
            </div>
          </header>

          <div class="article-content">



<h2>Classifier for skin lesion</h2>

<p>Using public <a href='https://challenge2019.isic-archive.com/data.html'>data set</a> provided by the International Skin Imaging Collaboration (ISIC),
  a DenseNet model was trained to classify dermoscopic images for 8 categories with the inclusion of meta data (e.g., age, gender). This work is
  an extension of a project I've done previously developing a melanoma classifier (see <a href ='https://jyu-theartofml.github.io/posts/melanoma'>
    blog post</a>). <u>Please note this is NOT a diagnostic tool</u>, therefore the output of the model is not to be interpreted as an actual diagnosis.
    The potential of this model lies in the monitoring of skin lesions (especially for patients with family history), and encouraging the user
    to seek medical attention more efficiently.</p>

  Tables 1 and 2 below are the performance metrics of the baseline model (no meta data) and the final model (with meta data), respectively.</p>

  <table class="paleBlueRows" align="center">
     <caption align="top"><b>Table 1</b>. Performance metrics of the DenseNet classifier (no meta data)</caption>
  <thead>
  <tr>
  <th>Category</th>
  <th>Precision</th>
  <th>Recall</th>
  <th>F1</th>
  <th>AUC</th>
  </tr>
  </thead>
  <tfoot>

  </tfoot>
  <tbody>
  <tr>
  <td>Actinic keratosis</td>
  <td>0.56</td>
  <td>0.51</td>
  <td>0.53</td>
  <td>0.96</td>
  </tr>
  <tr>
  <td>Basal cell carcinoma</td>
  <td>0.81</td>
  <td>0.82</td>
  <td>0.81</td>
  <td>0.98</td>
  </tr>
  <tr>
  <td>Benign keratosis</td>
  <td>0.67</td>
  <td>0.75</td>
  <td>0.71</td>
  <td>0.94</td>
  </tr>
  <tr>
  <td>Dermatofibroma</td>
  <td>0.65</td>
  <td>0.65</td>
  <td>0.65</td>
  <td>0.99</td>
  </tr>
  <tr>
  <td>Melanoma</td>
  <td>0.69</td>
  <td>0.75</td>
  <td>0.72</td>
  <td>0.94</td>
  </tr>
  <tr>
  <td>Nevus</td>
  <td>0.91</td>
  <td>0.87</td>
  <td>0.89</td>
  <td>0.96</td>
  </tr>
  <tr>
  <td>Squamous cell carcinoma</td>
  <td>0.57</td>
  <td>0.67</td>
  <td>0.62</td>
  <td>0.97</td>
  </tr>
  <tr>
  <td>Vascular lesion</td>
  <td>0.77</td>
  <td>0.81</td>
  <td>0.79</td>
  <td>0.99</td>
  </tr>
  </tbody>
  </table>

<p></p>
<table class="paleBlueRows" align="center">
   <caption align="top"><b>Table 2</b>. Performance metrics of the DenseNet classifier (with meta data)</caption>
<thead>
<tr>
<th>Category</th>
<th>Precision</th>
<th>Recall</th>
<th>F1</th>
<th>AUC</th>
</tr>
</thead>
<tfoot>

</tfoot>
<tbody>
<tr>
<td>Actinic keratosis</td>
<td>0.57</td>
<td>0.67</td>
<td>0.62</td>
<td>0.97</td>
</tr>
<tr>
<td>Basal cell carcinoma</td>
<td>0.84</td>
<td>0.84</td>
<td>0.84</td>
<td>0.98</td>
</tr>
<tr>
<td>Benign keratosis</td>
<td>0.67</td>
<td>0.76</td>
<td>0.71</td>
<td>0.96</td>
</tr>
<tr>
<td>Dermatofibroma</td>
<td>0.55</td>
<td>0.92</td>
<td>0.69</td>
<td>0.99</td>
</tr>
<tr>
<td>Melanoma</td>
<td>0.76</td>
<td>0.75</td>
<td>0.76</td>
<td>0.95</td>
</tr>
<tr>
<td>Nevus</td>
<td>0.92</td>
<td>0.88</td>
<td>0.90</td>
<td>0.96</td>
</tr>
<tr>
<td>Squamous cell carcinoma</td>
<td>0.57</td>
<td>0.74</td>
<td>0.65</td>
<td>0.98</td>
</tr>
<tr>
<td>Vascular lesion</td>
<td>0.86</td>
<td>0.90</td>
<td>0.88</td>
<td>0.72</td>
</tr>
</tbody>
</table>

<p></p>

<h2>Flask app</h2>
    <p></p>
 <h2>Docker container</h2>
        <p></p>

<figure class="highlight"><pre><code class="language-Python" data-lang="Python">
base_model = MobileNet(input_shape=(192,192,3), include_top=False,weights='imagenet')

def Top_model(input_dim):
    top_model = Sequential()
    top_model.add(Flatten(input_shape=input_dim))
    top_model.add(Dense(512, activation='relu'))
    top_model.add(Dropout(0.6))
    top_model.add(Dense(512, activation='relu'))
    top_model.add(Dropout(0.6))
    top_model.add(Dense(1, activation='sigmoid'))

    return top_model

model2=Top_model(train_data.shape[1:])
model2.compile(optimizer=RMSprop(lr=0.0001), loss='binary_crossentropy', metrics=['accuracy',f1])

model2.fit(train_data, train_labels,
              epochs=5, batch_size=32,verbose=1,
              validation_data=(validation_data, validation_labels))

################# Use functional API to  create the full model#############
top_model2 = Top_model(base_model.output_shape[1:])
top_model2.load_weights('bottleneck_fc_model(3layer)_512size_mobilenet.h5')
model = Model(input=base_model.input, output=top_model2(base_model.output))

for layer in model.layers[:4]:
    layer.trainable=False
model.compile(loss='binary_crossentropy',
              optimizer=SGD(lr=1e-3, momentum=0.9),
              metrics=['accuracy',f1])
</code></pre></figure>
<p>After training the top model, I augmented the image files with <code class='highlighter-rouge'>ImageDataGenerator()</code> along with
  the default preprocessing function to scale the pixel values. I chose Stochastic Gradient Descend as the optimizer
  because that was the optimizer used on the original MobileNet.</p>




        <p>Binary cross entropy was a loss function used to optimize the model(the lower the score the better), it takes into account <i>confidence</i> of the prediction along with
          accuracy. The validation binary cross entropy was <b>0.43</b>, F1 score (balanced accuracy accounting for imbalanced
          class distribution) was <b>86%</b>, and AUC for ROC was <b>0.89 </b>(1 being the best).</p>






<h3> REFERENCES </h3>
  <p>[1]Herman, C. <b>Emerging Technologies for the Detection of Melanoma: Achieving Better Outcomes.</b>
    <i>Clinical, Cosmetic and Investigational Dermatology</i> 5 (2012): 195–212.</p>
  <p>[2]MobileNets: Efficient Convolutional Neural Networks for Mobile Vision Applications(https://arxiv.org/pdf/1704.04861.pdf)</p>
  <p>[3]Keras Documentation: https://keras.io/applications/</p>
  <p>[4]Esteva, A.,Kuprel, B., et al. <b>Dermatologist-level classification of skin cancer with deep neural networks</b>.
    <i>Nature</i> 542(2017): 115–118.</p>
<div id="disqus_thread" class="article-comments"></div>
<script src="https://chalk-1.disqus.com/embed.js" async defer></script>
<noscript>Please enable JavaScript to view the comments.</noscript>

</article>
<footer class="footer appear">
  <p>
    Chalk is a high quality, completely customizable, performant and 100% free
    blog template for Jekyll built by
    <a href="/about" title="About me">Nielsen Ramon</a>. Download it <a href="https://github.com/nielsenramon/chalk" rel="noreferrer noopener" target="_blank" title="Download Chalk">here</a>.
  </p>
</footer>

      </div>
    </div>
  </main>

  <script>
    window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
    ga('create','UA-28631876-6','auto');ga('send','pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async></script>


<script src="/assets/vendor.js"></script>



  <script src="/assets/webfonts.js"></script>




  <script src="/assets/scrollappear.js"></script>



<script src="/assets/application.js"></script>


</body>
</html>
