<!doctype html>
<html lang="en">

<head>
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The Art of Machine Learning</title>
  <meta name="description" content="Machine Learning, Deep Learning, Jenny Yu ">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Regression for taxi data">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://yinniyu.github.io/posts/taxi">
  <meta property="og:site_name" content="The Art of Machine Learning">
  <meta property="og:image" content="">

 
  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
  <link href="http://chalk.nielsenramon.com/feed.xml" type="application/rss+xml" rel="alternate" title="Chalk Last 10 blog posts" />

    <link rel="stylesheet" href="/assets/light.css">
<!-- D3.js -->
     <script src="http://d3js.org/d3.v3.js"></script>
    <!--script src="http://d3js.org/d3.v2.min.js?2.8.1"></script>-->
	<!-- jQuery -->
   <script src="https://yinniyu.github.io/posts/jquery.min.js"></script>

	<!-- Open Sans & CSS -->
	<!--link href='http://fonts.googleapis.com/css?family=Open+Sans:700,400,300' rel='stylesheet' type='text/css'-->
	  <style>

    body{
      font-family: 'Open Sans', sans-serif;
      font-size:10px;
      text-align: center;
    }
    @import url(style.css);

    #circle circle {
    fill: none;
    pointer-events: all;
    }

    .group path {
    fill-opacity: .5;
    }

    path.chord {
    stroke: #000;
    stroke-width: .05px;
  }

    #circle:hover path.fade {
    display: none;
    }


	  </style>
  
 </head>


<body>
  <main>
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav appear">
  <a href="/" class="header-logo" title="The Art of Machine Learning">The Art of Machine Learning</a>
  <ul class="header-links">
       <li>
        <a href="https://yinniyu.github.io/about">About Me
        </a>
      </li>
    
     <li>
        <a href="https://yinniyu.github.io/toolbox">My Toolbox</a>
      </li>
    
     <li>
        <a href="https://github.com/yinniyu" rel="noreferrer noopener" target="_blank" title="GitHub">
          <span class="icon icon-github"></span>
        </a>
      </li>
    
    
      <li>
        <a href="https://linkedin.com/in/jenny-yu-b495243" rel="noreferrer noopener" target="_blank" title="LinkedIn">
          <span class="icon icon-linkedin"></span>
        </a>
      </li>   
  </ul>
</nav>

        
        <article class="article appear">
          <header class="article-header">
            <h1 id="circos plot">Plotting chord diagram in D3 </h1>
            <p>This post revisits the taxi ride data to make an interactive circos diagram in D3. Originally presented in 2009 by Martin Krzywinsk in his 
		    paper "Circos: an Information Aesthetic for Comparative Genomics.", it has become widely used and appreciated outside of the genomic/bioinformatic
		    community. Its aesthetics and features effectively display relationships between different entities or patterns in periodic data.
		  For the taxi data, it's actually quite simple to produce a circos Chord diagram by tweaking existing codes 
		    shared by users (i.e, AndrewRP, nbremer) on https://bl.ocks.org/ , plus I will break down the essential elements of the chord diagram.</p>
            
            <div class="article-list-footer">
              <span class="article-list-date">
                March 26, 2018
              </span>
              <span class="article-list-divider">-</span>
              <span class="article-list-minutes">
              10 minute read
              </span>
              
              <span class="article-list-divider">-</span>
              <div class="article-list-tags">
                
                <span class="article-list-divider">D3,Data visualization, Chord diagram </span>
              </div>
            </div>
          </header>

          <div class="article-content">

		  <div id="chart">
			  <script src="chord.js"></script></div>

<h2 id="chord background">Chord Diagram</h2>
 <p>There are <a href='https://github.com/nicgirault/circosJS'> many flavors of circos diagram </a> depending on the application. To show the flow and magnitude of
	 of the taxi ride data, chord diagam is the most appropriate. The each chord displays the flow or relatinship(e.g., correlation)
	 between different entities, and the metric of interest can be visualized by the width of each chord. The input for the chord diagram is a standard matrix 
	 called the 'Adjacency matrix' [1], in which a nxn matrix quantifies the flow from X to Y. In this matrix, the row names and columns names are identical and in the 
	 same order. For the taxi data, the rows(i) and columns(j) represent the pick up location and dropoff location, respectively.
	 The matrix value(i,j) is the number of people going from location i to location j, and it determines the thickness of the corresponding chord. To retrieve neighbourhood names from the raw data, I used the Python packages <i>geopy</i> and <i>pygeocoder</i> to extract the neighbourhood information using 
	 GPS coordinates for the pickup and dropoff locations.The codes are available <a href= 'https://github.com/yinniyu/kaggle_taxi/blob/master/geomap_visual'> here</a>,
	 and the outputs are the matrix json file, and a .csv file with row names and html color codes.</p>
	 
<h2 id="step1">Part  I. Donut Chart</h2>
 <p>The Donut Chart (Fig.1) serves as the backbone of the chord diagram. To make the donut, define the layout with <code class="highlighter-rouge"> d3.layout.chord() </code> 
	 and <code class="highlighter-rouge">d3.svg.arc() </code>. A mouseover function is added to show how many people are leaving that neighborhood.
	 See complete codes <a href='https://github.com/yinniyu/yinniyu.github.io/blob/master/posts/chord_test1.js'>here 
	 </a></p>

 <figure>
   <img src="images/d3/test1.png" alt="donut" >
   <figcaption>Fig.1. Donut chart showing the arcs corresponding to the groups. The size of each arc is determined by the sum of the values of that group (
	   summing along the columns for row i). 
   </figcaption>
   </figure>
 

<h2 id="full chord">Adding chords and text labels</h2>

<p>Chords and text labels (Fig.2) are added to the donut with the following additional code:</p>
		  
<figure class="highlight"><pre><code class="language-javascript" data-lang="Javascript">
//add name of the groups
group.append("svg:text")
  	.each(function(d) { d.angle = ((d.startAngle + d.endAngle) / 2);})
  	.attr("dy", ".25em")
  	.attr("class", "titles")
  	.attr("text-anchor", function(d) { return d.angle > Math.PI ? "end" : null; })
  	.attr("transform", function(d,i) {
  		var c = arc.centroid(d);
  		return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")"
  		+ "translate(" + (innerRadius + 15) + ")" //how close the labels are to the outer arc
  		+ (d.angle > Math.PI ? "rotate(180)" : "")
  	})
  	.text(function(d,i) { return cities[i].name; });

// Add the chords.
var chord = svg.selectAll(".chord")
    .data(layout.chords)
		.enter().append("path")
		.attr("class", "chord")
		.style("fill", function(d) { return cities[d.source.index].color; })
		.attr("d", path);
</code></pre></figure>
   
   <figure>
   <img src="https://raw.githubusercontent.com/yinniyu/kaggle_taxi/master/geomap_visual/Screenshot-2018-3-23%20Chord%20to%20show%20Flows.png" alt="full chord" width=65%, height=65%>
   <figcaption>Fig.2. Chord diagram (no fading with mouseover).
   </figcaption>
   </figure>
  
 <p>Two codes are shown in my <a href='https://github.com/yinniyu/kaggle_quora'>github repository</a> - 
  the first one is the preprocessing step to build the embedding matrix, and the second code is for model training and tuning. 
  In short the LSTM architecture is shown in the code snippet below</p>

            
            
<figure class="highlight"><pre><code class="language-Python" data-lang="Python">
#setup the word vector embedding
from keras.layers.embeddings import Embedding

nb_words=137077+1 #unique words in corpus (training and test sets)
max_sentence_len=25
embedding_layer = Embedding(nb_words,300,
        weights=[embedding_matrix],
        input_length=max_sentence_len,trainable=False)
#############  LSTM model using functional API  ######################
lstm_layer =LSTM(128)

sequence_1_input = Input(shape=(max_sentence_len,), dtype='int32')
embedded_sequences_1 = embedding_layer(sequence_1_input)
x1 = lstm_layer(embedded_sequences_1)

sequence_2_input = Input(shape=(max_sentence_len,), dtype='int32')
embedded_sequences_2 = embedding_layer(sequence_2_input)
y1 = lstm_layer(embedded_sequences_2)

distance=Lambda(vec_distance, output_shape=vec_output_shape)([x1, y1])
dense1=Dense(16, activation='sigmoid')(distance)
dense1 = Dropout(0.3)(dense1)

bn2 = BatchNormalization()(dense1)
prediction=Dense(1, activation='sigmoid')(bn2)

model = Model(input=[sequence_1_input, sequence_2_input], output=prediction)
</code></pre></figure>

<h2 id="results">Performance</h2>

<p> With <code class="highlighter-rouge"> BatchNormalization()</code> and <code class="highlighter-rouge">Dropout(0.3)</code> applied to reduce overfitting,
  the LB log loss score was 0.32650. For this project, the number of training data was significantly lower than test data (400K vs. 2M).
  Collecting more training data can siginificantly boost model performance, as well as trying pretrained word vectors from different sources. </p> 

            <br>          
<h4 id="reference">REFERENCE</h4>
<p>[1] https://medium.com/@Marianattestad/a-treatise-on-making-circos-plots-from-genomic-data-7ff496849e0
<br>
[2] Using pre-trained word embeddings in a Keras model, https://blog.keras.io/using-pre-trained-word-embeddings-in-a-keras-model.html
            </p>
        

          
            <div id="disqus_thread" class="article-comments"></div>
            <script src="https://chalk-1.disqus.com/embed.js" async defer></script>
            <noscript>Please enable JavaScript to view the comments.</noscript>
          
        </article>
        <footer class="footer appear">
  <p>
    Chalk is a high quality, completely customizable, performant and 100% free
    blog template for Jekyll built by
    <a href="/about" title="About me">Nielsen Ramon</a>. Download it <a href="https://github.com/nielsenramon/chalk" rel="noreferrer noopener" target="_blank" title="Download Chalk">here</a>.
  </p>
</footer>

      </div>
    </div>
  </main>
  
  <script>
    window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
    ga('create','UA-28631876-6','auto');ga('send','pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async></script>


<script src="/assets/vendor.js"></script>



  <script src="/assets/webfonts.js"></script>




  <script src="/assets/scrollappear.js"></script>



<script src="/assets/application.js"></script>


</body>
</html>
